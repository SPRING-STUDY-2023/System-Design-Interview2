# 7μ¥. νΈν…” μμ•½ μ‹μ¤ν…


<aside>
π’΅ μ μ‚¬ν• μ‹μ¤ν… μ„¤κ³„ μ ν•

- μ—μ–΄λΉ„μ•¤λΉ„ μ‹μ¤ν… μ„¤κ³„
- ν•­κ³µκ¶ μμ•½ μ‹μ¤ν… μ„¤κ³„
- μν™” ν‹°μΌ“ μλ§¤ μ‹μ¤ν… μ„¤κ³„
</aside>

## 1λ‹¨κ³„ λ¬Έμ  μ΄ν•΄ λ° μ„¤κ³„ λ²”μ„ ν™•μ •

- `μ‹μ¤ν… κ·λ¨`
    
    5000κ° νΈν…”μ— 100λ§ κ° κ°μ‹¤μ„ κ°–μ¶ νΈν…” μ²΄μΈμ„ μ„ν• μ›Ήμ‚¬μ΄νΈ κµ¬μ¶•
    
- `μμ•½ κ΄€λ ¨`
    
    
    | μμ•½κΈ | μμ•½ μ‹μ— μ „λ¶€ μ§€λ¶, μ‹κ°„ μ ν• μ΅΄μ¬ |
    | --- | --- |
    | μλ‹¨ | νΈν…” μ›Ήμ‚¬μ΄νΈλ‚ μ•±μ—μ„λ§ κ°€λ¥ |
    | κΈ°λ¥ | μ·¨μ† κΈ°λ¥ μ§€μ› |
- `κΈ°νƒ€ κ³ λ ¤μ‚¬ν•­`
    - 10% μ΄κ³Ό μμ•½ κ°€λ¥ : μ‹¤μ  κ°μ‹¤ μλ³΄λ‹¤ λ” λ§μ€ κ°μ‹¤μ„ νλ§¤ν•  μ μμ–΄μ•Ό ν•¨ (μΌλ¶€ κ³ κ°μ΄ μ·¨μ†ν•  κ²ƒμ„ μ—Όλ‘μ— λ‘ )
    - κ°μ‹¤ κ°€κ²©μ€ μ λ™μ  (κ°μ‹¤μ΄ μ—¬μ λ΅μ΄μ§€μ— λ”°λΌ λ§¤μΌ λ‹¬λΌμ§ μ μμ)
- `μ£Όμ” κΈ°λ¥`
    - νΈν…” μ •λ³΄ νμ΄μ§€ ν‘μ‹
    - κ°μ‹¤ μ •λ³΄ νμ΄μ§€ ν‘μ‹
    - κ°μ‹¤ μμ•½ μ§€μ›
    - νΈν…”μ΄λ‚ κ°μ‹¤ μ •λ³΄λ¥Ό μ¶”κ°€/μ‚­μ /κ°±μ‹ ν•λ” κ΄€λ¦¬μ νμ΄μ§€ μ§€μ›
    - μ΄κ³Ό μμ•½ μ§€μ›

### λΉ„κΈ°λ¥ μ”κµ¬μ‚¬ν•­

- λ†’μ€ μμ¤€μ λ™μ‹μ„± μ§€μ› : μ„±μκΈ°, λ€κ·λ¨ μ΄λ²¤νΈ κΈ°κ°„μ—λ” μΌλ¶€ μΈκΈ° νΈν…”μ νΉμ • κ°μ‹¤μ„ μμ•½ν•λ ¤λ” κ³ κ°μ΄ λ§μ΄ λ°λ¦΄ μ μμ
- μ μ ν• μ§€μ—° μ‹κ°„ : μ‚¬μ©μκ°€ μμ•½ν•  λ• μ‘λ‹µ μ‹κ°„μ΄ λΉ λ¥΄λ©΄ μ΄μƒμ μ΄μ§€λ§, λ‡ μ΄ μ •λ„ μ”μ²­μ„ μ²λ¦¬ν•λ” λ° κ±Έλ¦¬λ” κ²ƒμ€ κ°μ•

### κ°λµμ  κ·λ¨ μ¶”μ •

- μ΄ 5000κ° νΈν…”. 100λ§ κ°μ κ°μ‹¤μ΄ μλ‹¤κ³  κ°€μ •
- ν‰κ· μ μΌλ΅ κ°μ‹¤μ 70%λ§ μ‚¬μ© μ¤‘, ν‰κ·  ν¬μ™ κΈ°κ°„μ€ 3μΌλ΅ κ°€μ •
- μΌμΌ μμƒ μμ•½ κ±΄μ : (1λ°±λ§X0.7) / 3 = 233,333 (μ•½ 240,000 κ±΄)
- μ΄λ‹Ή μμ•½ κ±΄μ : 240,000 / ν•λ£¨μ— 10^5μ΄ =~ 3  β†’ μ΄λ‹Ή μμ•½ TPSλ” κ·Έλ¦¬ λ†’μ§€ μ•μ

<aside>
π‘¤ μ μ € μ‹λ‚λ¦¬μ¤

1. νΈν…”/κ°μ‹¤ μƒμ„Έ νμ΄μ§€ : μ‚¬μ©μκ°€ νΈν…”/κ°μ‹¤ μ •λ³΄λ¥Ό ν™•μΈν•λ‹¤ (μ΅°ν λ°μƒ) `QPS=300`
2. μμ•½ μƒμ„Έ μ •λ³΄ νμ΄μ§€ : μ‚¬μ©μκ°€ λ‚ μ§, ν¬μ™ μΈμ›, κ²°μ  λ°©λ²• λ“±μ μƒμ„Έ μ •λ³΄λ¥Ό μμ•½ μ „μ— ν™•μΈν•λ‹¤ (μ΅°ν λ°μƒ) `QPS=30`
3. κ°μ‹¤ μμ•½ νμ΄μ§€ : μ‚¬μ©μκ°€ β€μμ•½β€™ λ²„νΌμ„ λλ¬ κ°μ‹¤μ„ μμ•½ν•λ‹¤ (νΈλμ­μ… λ°μƒ) `QPS=3`

*μµμΆ… μμ•½ TPSκ°€ 3μΈ κ²ƒμ„ λ°”νƒ•μΌλ΅, μ—­μ‚°ν• κ²°κ³Ό (μ•½ 10%μ μ‚¬μ©μκ°€ λ‹¤μ λ‹¨κ³„λ΅ μ§„ν–‰ν•κ³ , 90%λ” μµμΆ… λ‹¨κ³„μ— λ„λ‹¬ν•κΈ° μ „μ— μ΄νƒν•λ‹¤κ³  κ°€μ •)

</aside>

## 2λ‹¨κ³„ κ°λµμ  μ„¤κ³„μ• μ μ‹ λ° λ™μ κµ¬ν•κΈ°

### API μ„¤κ³„

- νΈν…” κ΄€λ ¨ API
    
    
    | API | Description |
    | --- | --- |
    | GET /v1/hotels/id | νΈν…”μ μƒμ„Έ μ •λ³΄ λ°ν™ |
    | POST /v1/hotels | μ‹ κ· νΈν…” μ¶”κ°€ (νΈν…” μ§μ› only) |
    | PUT /v1/hotels/id | νΈν…” μ •λ³΄ κ°±μ‹  (νΈν…” μ§μ› only) |
    | DELETE /v1/hotels/id | νΈν…” μ •λ³΄ μ‚­μ  (νΈν…” μ§μ› only) |
- κ°μ‹¤ κ΄€λ ¨ API
    
    
    | API | Description |
    | --- | --- |
    | GET /v1/hotels/:id/rooms/id | κ°μ‹¤ μƒμ„Έ μ •λ³΄ λ°ν™ |
    | POST /v1/hotels/:id/rooms | μ‹ κ· κ°μ‹¤ μ¶”κ°€ (νΈν…” μ§μ› only) |
    | PUT /v1/hotels/:id/rooms/id | κ°μ‹¤ μ •λ³΄ κ°±μ‹  (νΈν…” μ§μ› only) |
    | DELETE /v1/hotels/:id/rooms/id | κ°μ‹¤ μ •λ³΄ μ‚­μ  (νΈν…” μ§μ› only) |
- μμ•½ κ΄€λ ¨ API
    
    
    | API | Description |
    | --- | --- |
    | GET /v1/reservations | λ΅κ·ΈμΈ μ‚¬μ©μμ μμ•½ μ΄λ ¥ λ°ν™ |
    | GET /v1/reservations/id | νΉμ • μμ•½μ μƒμ„Έ μ •λ³΄ λ°ν™ |
    | POST /v1/reservations | μ‹ κ· μμ•½ |
    | DELETE /v1/reservations/id | μμ•½ μ·¨μ† |
    - Request Body
        
        ```json
        {
        		"startDate": "2021-08-17",
        		"endDate": "2021-08-18",
        		"hotelID": "245",
        		"roomID": "U1234567", 
        		"reservationID": "12333"   // μ΄μ¤‘ μμ•½ λ°©μ§€μ© **λ©±λ“± ν‚¤(idempotent key)**
        }
        ```
        

### λ°μ΄ν„° λ¨λΈ

<aside>
<img src="/icons/database_gray.svg" alt="/icons/database_gray.svg" width="40px" /> μ§€μ›ν•΄μ•Ό ν•  Query

1. νΈν…” μƒμ„Έ μ •λ³΄ ν™•μΈ (read)
2. μ§€μ •λ λ‚ μ§ λ²”μ„μ— μ‚¬μ© κ°€λ¥ν• κ°μ‹¤ μ ν• ν™•μΈ (read)
3. μμ•½ μ •λ³΄ κΈ°λ΅ (write)
4. μμ•½ λ‚΄μ—­ λλ” κ³Όκ±° μμ•½ μ΄λ ¥ μ •λ³΄ μ΅°ν (read)
</aside>

![λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§](https://github.com/user-attachments/assets/1e0814dd-fe24-4765-9b19-90107ce8573c)

λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§

> **κ΄€κ³„ν• λ°μ΄ν„°λ² μ΄μ¤**λ¥Ό μ„ νƒν•λ‹¤
> 
- **read** >> write λΉλ„μ μ½κΈ°κ°€ μ••λ„μ μΈ μ‘μ—… νλ¦„μ„ μ μ§€μ›ν•¨
    - λ°©λ¬Έμ μκ°€ μ‹¤μ λ΅ μμ•½ν•λ” μ‚¬μ©μ μλ³΄λ‹¤ ν›¨μ”¬ λ§μ„ κ²ƒ
- ACID(μ›μμ„±, μΌκ΄€μ„±, κ²©λ¦¬μ„±, μμ†μ„±)μ„ λ³΄μ¥
    - μμ•½ μ‹μ¤ν…μ—μ„ νΉν μ¤‘μ”ν• μ†μ„±
    - λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ¶©λ¶„ν λ³΄μ¥λλ‹¤λ©΄, μ• ν”λ¦¬μΌ€μ΄μ… μ½”λ“λ” ν›¨μ”¬ λ‹¨μν•΄μ§
- μ‰½κ² λ°μ΄ν„° λ¨λΈλ§ κ°€λ¥ (κµ¬μ΅°, μ—”ν‹°ν‹° κ°„μ κ΄€κ³„λ¥Ό μ•μ •μ μΌλ΅ μ§€μ›)

**[μƒνƒ μ²μ΄λ„ λ‹¤μ΄μ–΄κ·Έλ¨]**

```mermaid
graph TD
    κ²°μ λ€κΈ° --> μ·¨μ†
    κ²°μ λ€κΈ° --> κ²°μ μ™„λ£
    κ²°μ λ€κΈ° --> μΉμΈμ‹¤ν¨
    κ²°μ μ™„λ£ --> ν™λ¶μ™„λ£

```

μ—μ–΄λΉ„μ•¤λΉ„μ κ²½μ°, room_idκ°€ μμΌλ―€λ΅ λ¬Έμ κ°€ λμ§€ μ•μ§€λ§

νΈν…”μ κ²½μ°, μ‚¬μ©μκ°€ νΉμ • κ°μ‹¤μ΄ μ•„λ‹ **νΉμ • νΈν…”μ νΉμ • κ°μ‹¤ μ ν•**[μ¤νƒ λ‹¤λ“ λ£Έ/ν‚Ή μ‚¬μ΄μ¦ λ£Έ/ν€Έ μ‚¬μ΄μ¦ λ£Έ]μ„ μμ•½ν•λ―€λ΅ room_idκ°€ μ΅΄μ¬ν•μ§€ μ•μΌλ―€λ΅, μ„ DB μ¤ν‚¤λ§λ” λ¬Έμ κ°€ λλ‹¤.

### κ°λµμ  μ„¤κ³„μ•

![IMG_8153.jpg](https://github.com/user-attachments/assets/aef741ca-13a7-47d4-9683-3b7ac9b70ec4)

> MSA μ•„ν‚¤ν…μ² μ‚¬μ©
> 
- `μ‚¬μ©μ` : κ°μ‹¤μ„ μμ•½ν•λ” λ‹Ήμ‚¬μ
- `κ΄€λ¦¬μ(νΈν…” μ§μ›)` : κ³ κ° ν™λ¶, μμ•½ μ·¨μ†, κ°μ‹¤ μ •λ³΄ κ°±μ‹  λ“±μ κ΄€λ¦¬ μ‘μ—… μν–‰
- `CDN` : μ΄λ―Έμ§€, λ™μμƒ, HTML λ“± λ¨λ“  μ •μ  μ½ν…μΈ λ¥Ό μΊμ‹ν•μ—¬ μ›Ήμ‚¬μ΄νΈ λ΅λ“ μ„±λ¥μ„ κ°μ„ ν•λ” λ° μ΄μ©
- `κ³µκ° API κ²μ΄νΈμ›¨μ΄` : μ²λ¦¬μ¨ μ ν•, μΈμ¦ λ“±μ κΈ°λ¥μ„ μ§€μ›ν•λ” μ™„μ „ κ΄€λ¦¬ν• μ„λΉ„μ¤
    - μ—”λ“ν¬μΈνΈλ¥Ό κΈ°λ°μΌλ΅ νΉμ • μ„λΉ„μ¤μ— μ”μ²­ μ „λ‹¬
- `λ‚΄λ¶€ API` : μΉμΈλ νΈν…” μ§μ›λ§ μ‚¬μ© κ°€λ¥ν• API (by λ‚΄λ¶€ μ†ν”„νΈμ›¨μ–΄, μ›Ήμ‚¬μ΄νΈ)
    - VPN λ“±μ κΈ°μ λ΅ λ³΄μ• κµ¬μ„±
- `νΈν…” μ„λΉ„μ¤` : νΈν…”κ³Ό κ°μ‹¤μ— λ€ν• μƒμ„Έ μ •λ³΄ μ κ³µ (λ€λ¶€λ¶„ μ •μ  λ°μ΄ν„° β‡’ μΊμ‹ν•΄λ‘ )
- `μ”κΈ μ„λΉ„μ¤` : λ―Έλμ μ–΄λ–¤ λ‚ μ— μ–΄λ–¤ μ”κΈμ„ λ°›μ•„μ•Ό ν•λ”μ§€ λ°μ΄ν„°λ¥Ό μ κ³µν•λ” μ„λΉ„μ¤
- `μμ•½ μ„λΉ„μ¤` : μμ•½ μ”μ²­μ„ λ°›κ³  κ°μ‹¤μ„ μμ•½ν•λ” κ³Όμ • μ²λ¦¬, μ”μ—¬ κ°μ‹¤ μ •λ³΄ κ°±μ‹  μ²λ¦¬
- `κ²°μ  μ„λΉ„μ¤` : κ³ κ°μ κ²°μ λ¥Ό λ§΅μ•„ μ²λ¦¬ν•κ³ , μ μ°¨μ μ„±κ³µ/μ‹¤ν¨ μ—¬λ¶€μ— λ”°λΌ μƒνƒ μ—…λ°μ΄νΈ
- `νΈν…” κ΄€λ¦¬ μ„λΉ„μ¤` : μΉμΈλ νΈν…” μ§μ›λ§ μ‚¬μ© κ°€λ¥ν• μ„λΉ„μ¤
    - μ„λ°•ν• μμ•½ κΈ°λ΅ ν™•μΈ, κ³ κ° κ°μ‹¤ μμ•½, μμ•½ μ·¨μ† λ“±μ admin κΈ°λ¥ μ κ³µ

**[λ‹¨μν™”ν• μ„λΉ„μ¤ κ°„ μ—°κ²° κ΄€κ³„]**

```mermaid
graph TD
		μμ•½μ„λΉ„μ¤ --> μ”κΈμ„λΉ„μ¤

```

```mermaid
graph TD
    νΈν…”κ΄€λ¦¬μ„λΉ„μ¤ --> νΈν…”μ„λΉ„μ¤
    νΈν…”κ΄€λ¦¬μ„λΉ„μ¤ --> μ”κΈμ„λΉ„μ¤
    νΈν…”κ΄€λ¦¬μ„λΉ„μ¤ --> μμ•½μ„λΉ„μ¤
    νΈν…”κ΄€λ¦¬μ„λΉ„μ¤ --> κΈ°νƒ€μ„λΉ„μ¤[......]
```

*μ‹¤μ  μƒμ—…μ μΌλ΅ μ΄μ©λλ” μ‹μ¤ν…μ μ„λΉ„μ¤ κ°„ ν†µμ‹ μ— gRPCμ™€ κ°™μ€ κ³ μ„±λ¥ μ›κ²© ν”„λ΅μ‹μ € νΈμ¶ ν”„λ μ„μ›ν¬λ¥Ό μ‚¬μ©ν•λ” κ²½μ°κ°€ λ§λ‹¤.

## 3λ‹¨κ³„ μƒμ„Έ μ„¤κ³„

### κ°μ„ λ λ°μ΄ν„° λ¨λΈ

νΈν…”μ μ”κµ¬μ‚¬ν•­λ„ λ§μ΅±ν•κΈ° μ„ν•΄μ„λ” (room_idλ¥Ό μ‹λ³„μλ΅ μ‚¬μ© λ¶κ°€) λ‹¤μκ³Ό κ°™μ€ μμ •μ΄ ν•„μ”ν•λ‹¤. 

[DB Schema]

![Untitled](https://github.com/user-attachments/assets/e6875689-349b-42e8-86b5-73c1da0ddd6d)

- room : κ°μ‹¤μ— κ΄€κ³„λ μ •λ³΄
- room_type_rate : νΉμ • κ°μ‹¤ μ ν•μ νΉμ • μΌμ μ”κΈ μ •λ³΄
- reservation : ν¬μ™κ° μμ•½ μ •λ³΄
- **room_type_inventory** : νΈν…”μ λ¨λ“  κ°μ‹¤ μ ν•
    - total_inventory : (μ΄ κ°μ‹¤ μ - μΌμ‹μ μΌλ΅ μ μ™Έν• κ°μ‹¤ μ)
    - total_reserved : μ§€μ •λ hotel_id, room_type_id, dateμ— μμ•½λ λ¨λ“  κ°μ‹¤μ μ
    
    π”‘Β pk - **`(hotel_id, room_type_id, date)`**
    
    β†’ μ£Όλ΅ κ³ κ°μ΄ νΉμ • μ ν•μ κ°μ‹¤μ„ μμ•½ν•  μ μλ”μ§€ μ—¬λ¶€λ¥Ό ν™•μΈν•  λ• μ‚¬μ©
    

[API λ³€κ²½μ‚¬ν•­] 

 `POST` /v1/reservations

- Request Param
    
    ```json
    {
    		"startDate": "2021-08-17",
    		"endDate": "2021-08-18",
    		"hotelID": "245",
    		**"roomTypeID": "U1234567",** 
    		"reservationID": "12333"  
    }
    ```
    
    - roomID β†’ roomTypeID

[μ €μ¥ μ©λ‰ μ¶”μ •]

*2λ…„ μ΄λ‚΄ λ¨λ“  λ―Έλ λ‚ μ§μ— λ€ν• κ°€μ© κ°μ‹¤ λ°μ΄ν„° κ²°κ³Όλ¥Ό ν† λ€λ΅ λ°μ΄ν„°λ¥Ό μ±„μ›λ‘” μƒνƒμ—¬μ•Ό ν•¨

**`room_type_inventory`** ν…μ΄λΈ”μ— μ €μ¥ν•΄μ•Ό ν•  λ μ½”λ“ μ

5,000 (νΈν…” μ) X 20 (κ°μ‹¤ μ ν•) X 2λ…„ X 365μΌ = μ•½ 7,300λ§ κ° 

κ·Έλ¦¬ λ§μ€ λ°μ΄ν„°λ” μ•„λ‹λ―€λ΅ 1κ°μ λ°μ΄ν„°λ² μ΄μ¤λ§ μ‚¬μ©ν•΄λ„ μ¶©λ¶„ν•μ§€λ§, λ°μ΄ν„°λ² μ΄μ¤ μ„λ²„λ¥Ό ν•λ‚λ§ λ‘λ” κ²ƒ μμ²΄λ§μΌλ΅ SPOF λ¬Έμ λ” λ”°λ¥Ό μ μμ–΄ λ€λΉ„κ°€ ν•„μ”ν•λ‹¤. 

β†’ κ³ κ°€μ©μ„±μ„ μ„ν•΄ μ—¬λ¬ μ§€μ—­/κ°€μ©μ„± κµ¬μ—­μ— DBλ¥Ό λ³µμ ν•μ—¬ ν•΄κ²° κ°€λ¥

<aside>
π¤” *λ§μ•½ μμ•½ λ°μ΄ν„°κ°€ λ‹¨μΌ DBμ— λ‹΄κΈ°μ— λ„λ¬΄ ν¬λ‹¤λ©΄?*

1. **ν„μ¬ λ° ν–¥ν›„ μμ•½ λ°μ΄ν„°λ§ μ €μ¥** β†’ μμ•½ μ΄λ ¥μ€ μμ£Ό μ ‘κ·Όν•μ§€ μ•μΌλ―€λ΅ μ•„μΉ΄μ΄λΉ™ ν•κ±°λ‚ cold storageλ΅ μ΄λ™
2. **λ°μ΄ν„°λ² μ΄μ¤ μƒ¤λ”© -** hotel_idλ¥Ό μƒ¤λ”© ν‚¤λ΅ μ‚¬μ©ν•μ—¬, `hash(hotel_id)%number_of_servers`λ΅ μƒ¤λ”©ν•΄λ‘κΈ°
    
    *μμ£Ό μ‚¬μ©λλ” μ§μ - 1) μμ•½ 2) ν¬μ™κ° μ΄λ¦„μΌλ΅ μμ•½ ν™•μΈ
    
</aside>

### λ™μ‹μ„± λ¬Έμ 

> *μ΄μ¤‘ μμ•½μ„ μ–΄λ–»κ² λ°©μ§€ν•  μ μμ„κΉ?*
> 

**#1. κ°™μ€ μ‚¬μ©μκ°€ μμ•½ λ²„νΌμ„ μ—¬λ¬ λ² λ„λ¥Ό μ μλ‹¤**

![Untitled](https://github.com/user-attachments/assets/5549fa3f-1dde-4c8f-b0ff-1e00b3bbebf8)

1. ν΄λΌμ΄μ–ΈνΈ μΈ΅ κµ¬ν„
    
    ν΄λΌμ΄μ–ΈνΈμ—μ„ μ”μ²­ μ „μ†΅ μ΄ν›„, β€μμ•½β€™ λ²„νΌμ„ λΉ„ν™μ„±ν™” ν•λ” λ“±μ μ²λ¦¬
    
    β†’ but, κ·Έλ¦¬ μ•μ •μ μ΄μ§€ λ»ν•¨
    
2. λ©±λ“± API : λ‡ λ²μ„ νΈμ¶ν•΄λ„ κ°™μ€ κ²°κ³Όλ¥Ό λ‚΄λ” API
    
    μμ•½ APIμ μ”μ²­μ— λ©±λ“± ν‚¤λ¥Ό μ¶”κ°€ν•κΈ° (e.g. `reservation_id`)
    

```mermaid
sequenceDiagram
    participant μ‚¬μ©μ
    participant μμ•½ μ„λΉ„μ¤
    μ‚¬μ©μ->>μμ•½ μ„λΉ„μ¤: 1. μμ•½ μ£Όλ¬Έ μƒμ„±
    μμ•½ μ„λΉ„μ¤-->>μ‚¬μ©μ: 2. μμ•½ μ£Όλ¬Έμ„ ν‘μ‹ (reservation_id)
    μ‚¬μ©μ->>μμ•½ μ„λΉ„μ¤: 3-1. μμ•½ μ μ¶ (reservation_id) 
    μ‚¬μ©μ->>μμ•½ μ„λΉ„μ¤: 3-2. μμ•½ μ μ¶ (reservation_id) <br>***μ μΌμ„± μ΅°κ±΄ μ„λ°**

```

![Untitled](https://github.com/user-attachments/assets/fa38d07a-ca26-4e9c-bc75-a612e4b410c3)

- `reservation_id` λ” μ „μ—­μ  μ μΌμ„±μ„ λ³΄μ¦ν•λ” ID μƒμ„±κΈ°κ°€ λ§λ“¤μ–΄ λ‚Έ μ‹λ³„μλ‹¤.  (3-1μ—μ„ μƒλ΅ μƒμ„±λ¨)
- λ§μ•½ 3-2μ—μ„ λ™μΌν• μ”μ²­μ΄ μ¤λ©΄, ν•΄λ‹Ή reservation_idμ— λ€ν• κΈ°λ³Έ ν‚¤μ μ μΌμ„± μ΅°κ±΄μ΄ μ„λ°λμ–΄ **μƒλ΅μ΄ λ μ½”λ“λ¥Ό μƒμ„±ν•μ§€ μ•λ”λ‹¤.  (β†’ μ΄μ¤‘ μμ•½ λ¬Έμ λ” ν”Όν•  μ μμ)**

**#2. μ—¬λ¬ μ‚¬μ©μκ°€ κ°™μ€ κ°μ‹¤μ„ λ™μ‹μ— μμ•½ν•κ³ μ ν•  μ μλ‹¤**

*DB νΈλμ­μ… κ²©λ¦¬ μμ¤€μ΄ κ°€μ¥ λ†’μ€ μμ¤€(μ§λ ¬ν™” κ°€λ¥ μμ¤€)μ΄ μ•„λ‹λΌκ³  κ°€μ •

[μ΄κΈ° μ„¤μ •] total_inventory = 100, total_reserved = 99

π‘¤Β μ‚¬μ©μ1 (= νΈλμ­μ…1) 

1. μ”μ—¬κ°μ‹¤ ν™•μΈ : 1κ° λ‚¨μ
2. κ°μ‹¤ μμ•½ : ***total_reserved += 1***
    
    (total_reserved + rooms_to_book) β‰¤ total_inventoryμΈμ§€ κ²€μ‚¬ β‡’ **True**
    

---

total_inventory = 100, total_reserved = 100

π‘¤Β μ‚¬μ©μ2 (= νΈλμ­μ…2) 

a. μ”μ—¬κ°μ‹¤ ν™•μΈ : 1κ° λ‚¨μ

c. κ°μ‹¤ μμ•½ : ***total_reserved += 1***

(total_reserved + rooms_to_book) β‰¤ total_inventoryμΈμ§€ κ²€μ‚¬ β‡’ **True**

---

total_inventory = 100, total_reserved = 100

μ„ μƒν™©μ—μ„ νΈλμ­μ… 1μ΄ μ»¤λ°‹ν•κΈ° μ§μ „κΉμ§€λ” νΈλμ­μ… 2μ— λ³΄μ΄μ§€ μ•λ”λ‹¤. κ²°κ³Όμ μΌλ΅ μ΄μ¤‘ μμ•½μ΄ λ°μƒν• κ²ƒμ΄λ‹¤. 

β†’ μ΄λ” λ½(lock) κΈ°λ²•μΌλ΅ ν•΄κ²°ν•  μ μλ‹¤. 

[λ½ λ©”μ»¤λ‹μ¦]

**A. λΉ„κ΄€μ  λ½** (λΉ„κ΄€μ  λ™μ‹μ„± μ μ–΄ λ°©μ•)

> μ‚¬μ©μκ°€ λ μ½”λ“λ¥Ό κ°±μ‹ ν•λ ¤κ³  ν•λ” μκ°„ μ¦‰μ‹ λ½μ„ κ±Έμ–΄ λ™μ‹ μ—…λ°μ΄νΈλ¥Ό λ°©μ§€ν•λ” κΈ°μ 
> 

![Untitled](https://github.com/user-attachments/assets/e040c6c8-a4f7-4d05-bd27-3d8b357fcdfe)

- ν•΄λ‹Ή λ μ½”λ“λ¥Ό κ°±μ‹ ν•λ ¤λ” λ‹¤λ¥Έ μ‚¬μ©μλ” λ¨Όμ € λ½μ„ κ±΄ μ‚¬μ©μκ°€ λ³€κ²½μ„ λ§μΉκ³  λ½μ„ ν•΄μ ν•  λ•κΉμ§€ κΈ°λ‹¤λ ¤μ•Ό ν•¨
- e.g. MySQLμ `SELECT ... FOR UPDATE` λ¬Έ

π‘π»Β μ¥μ 

- μ• ν”λ¦¬μΌ€μ΄μ…μ΄ λ³€κ²½ μ¤‘μ΄κ±°λ‚ λ³€κ²½μ΄ λλ‚ λ°μ΄ν„°λ¥Ό κ°±μ‹ ν•λ” μƒν™©μ„ λ§‰μ„ μ μμ
- κµ¬ν„μ΄ μ‰½κ³ , λ¨λ“  κ°±μ‹  μ—°μ‚°μ„ μ§λ ¬ν™”ν•μ—¬ μ¶©λμ„ λ§‰μ (race conditionμ΄ μ‹¬ν• κ²½μ°μ— μ ν•©)

π‘π»Β λ‹¨μ 

- μ—¬λ¬ λ μ½”λ“μ— λ½μ„ κ±Έλ©΄ deadlockμ΄ λ°μƒν•  μ μμ (μ½”λ“λ„ λ§¤μ° κΉλ‹¤λ΅μ›μ§)
- ν™•μ¥μ„±μ΄ λ‚®μ β†’ λ„λ¬΄ μ¤λ«λ™μ• νΈλμ­μ…μ΄ λ½μ„ μ΅κ³  μμΌλ©΄ λ‹¤λ¥Έ νΈλμ­μ…μ΄ μμ›μ— μ ‘κ·Όν•  μ μ—†μΌλ―€λ΅ DB μ„±λ¥μ΄ κ½¤λ‚ μ €ν•λ  κ²ƒ

**B. λ‚™κ΄€μ  λ½** (λ‚™κ΄€μ  λ™μ‹μ„± μ μ–΄ λ°©μ•)

> μ—¬λ¬ μ‚¬μ©μκ°€ λ™μ‹μ— κ°™μ€ μμ›μ„ κ°±μ‹ ν•λ ¤ μ‹λ„ν•λ” κ²ƒμ„ ν—μ©
> 

![Untitled](https://github.com/user-attachments/assets/3bd9cd70-9723-46d9-8d22-9e57c0c4ab51)

1. DB ν…μ΄λΈ”μ— `version` μ»¬λΌ μ¶”κ°€
2. μ‚¬μ©μκ°€ λ μ½”λ“ μμ • μ „μ— μ• ν”λ¦¬μΌ€μ΄μ…μ€ ν•΄λ‹Ή λ μ½”λ“μ `version`μ„ μ½μ
3. κ°±μ‹  μ‹, **`version+1`**λ΅ κΈ°λ΅
4. μ ν¨μ„± κ²€μ‚¬ μν–‰ - μ‹¤ν¨ μ‹ νΈλμ­μ… abort β†’ (b)λ¶€ν„° λ‹¤μ‹ μν–‰

β†’ κµ¬ν„ λ°©μ‹

1. λ²„μ „ λ²νΈ β…Β **μ„λ²„ μ‹κ³„κ°€ λ¶€μ •ν™•ν•΄μ§ μ μμΌλ―€λ΅ λ²„μ „ λ²νΈκ°€ λ” μΆ‹μ€ μ„ νƒμ§€**
2. νƒ€μ„μ¤νƒ¬ν”„

π‘π»Β μ¥μ 

- μ• ν”λ¦¬μΌ€μ΄μ…μ΄ μ ν¨ν•μ§€ μ•μ€ λ°μ΄ν„°λ¥Ό νΈμ§‘ν•λ” μΌμ„ λ§‰μ
- λ°μ΄ν„°λ² μ΄μ¤ μμ›μ— λ½μ„ κ±Έ ν•„μ” X
    - `λ²„μ „ λ²νΈ` - μ• ν”λ¦¬μΌ€μ΄μ…μ— **λ°μ΄ν„° μΌκ΄€μ„±μ μ±…μ„**μ„ λ„κΈ°λ” κ²ƒ
    - λΉ„κ΄€μ  λ½λ³΄λ‹¤ λΉ λ¦„
- λ°μ΄ν„°μ— λ€ν• κ²½μμ΄ μΉμ—΄ν•μ§€ μ•μ€ μƒν™©μ— μ ν•© β†’ λ½μ„ κ΄€λ¦¬ν•λ” λΉ„μ© μ—†μ΄ νΈλμ­μ… μ‹¤ν–‰ κ°€λ¥

π‘π»Β λ‹¨μ 

- λ™μ‹μ„± μμ¤€μ΄ μ•„μ£Ό λ†’μ€, κ²½μμ΄ μΉμ—΄ν• μƒν™©μ—μ„λ” μ„±λ¥μ΄ μΆ‹μ§€ μ•μ

**β†’ μμ•½ QPSλ” μΌλ°μ μΌλ΅ λ†’μ§€ μ•μΌλ―€λ΅, νΈν…” μμ•½ μ‹μ¤ν…μ—μ„ λ‚™κ΄€μ  λ½μ€ μ ν•©ν• μ„ νƒμ§€μ΄λ‹¤.** 

**C. λ°μ΄ν„°λ² μ΄μ¤ μ μ•½μ΅°κ±΄**

> `room_type_inventory` ν…μ΄λΈ”μ— μ μ•½μ΅°κ±΄μ„ μ¶”κ°€ν•΄λ³΄μ.
> 
> 
> ```sql
> CONSTRAINT `check_room_count` CHECK((`total_inventory - total_reserved` >= 0))
> ```
> 

![Untitled](https://github.com/user-attachments/assets/374f5a82-d645-4606-be6a-ca1c9d7eeed0)

π‘π»Β μ¥μ 

- κµ¬ν„μ΄ μ‰¬μ›€
- λ°μ΄ν„°μ— λ€ν• κ²½μμ΄ μ‹¬ν•μ§€ μ•μ„ λ• μ λ™μ‘

π‘π»Β λ‹¨μ 

- λ°μ΄ν„°μ— λ€ν• κ²½μμ΄ μ‹¬ν•λ©΄ μ‹¤ν¨ν•λ” μ—°μ‚° μκ°€ λ§¤μ° λμ–΄λ‚κ² λ¨ (like λ‚™κ΄€μ  λ½)
- μ• ν”λ¦¬μΌ€μ΄μ… μ½”λ“μ™€ λ‹¬λΌ λ²„μ „μ„ ν†µμ ν•κΈ° μ–΄λ ¤μ›€
- μ μ•½μ΅°κ±΄μ„ ν—μ©ν•μ§€ μ•λ” DBλ„ μμ–΄ DBMSμ μ μ—°ν• κµμ²΄κ°€ λ¶κ°€λ¥ν•¨

### μ‹μ¤ν… κ·λ¨ ν™•μ¥

> *νΈν…” μμ•½ μ‹μ¤ν…μ΄ νƒ€ μ λ…ν• μ—¬ν–‰ μμ•½ μ›Ή μ‚¬μ΄νΈμ™€ μ—°λ™λμ–΄μ•Ό ν•λ‹¤λ©΄?*
> 

QPSκ°€ μ² λ°° μ΄μƒ λμ–΄λ‚  μ μλ” μƒν™©μ΄λ―€λ΅, μ‹μ¤ν… λ¶€ν•λ¥Ό λ§‰κΈ° μ„ν• κ³ λ―Όμ„ ν•΄λ΄μ•Ό ν•λ‹¤. 

**`λ°μ΄ν„°λ² μ΄μ¤ μƒ¤λ”©` -** β€λ°μ΄ν„°λ² μ΄μ¤μ κ·λ¨λ¥Ό λλ¦¬μβ€

- λ€λ¶€λ¶„μ μΏΌλ¦¬μ—μ„ hotel_idλ¥Ό ν•„μ”λ΅ ν•λ―€λ΅, ν•΄λ‹Ή ν‚¤λ¥Ό μƒ¤λ”© μ΅°κ±΄μΌλ΅ κ°€μ Έκ°€μ

**`μΊμ‹`** 

![Untitled](https://github.com/user-attachments/assets/73275c5f-0335-47b4-85ce-27de09bb2cd1)

- μ΄λ ¥ λ°μ΄ν„°λ” λ‹¤λ¥Έ DBλ¥Ό ν†µν•΄ μ§μν•λ„λ΅ ν•μ β†’ Redisκ°€ μ ν•© (TTL, LRU μΊμ‹ κµμ²΄ μ •μ±…μ„ μ‚¬μ©ν•΄ λ©”λ¨λ¦¬λ¥Ό μµμ μΌλ΅ μ‚¬μ©ν•  μ μκΈ° λ•λ¬Έ)
- μμ•½ νΈλν”½ μ¦κ°€μ— λ”°λΌ **λ°μ΄ν„° λ΅λ”© μ†λ„, DB ν™•μ¥μ„±**μ΄ λ¬Έμ κ°€ λλ‹¤λ©΄, DB μ•μ— μΊμ‹ κ³„μΈµμ„ λ‘μ–΄ ν•΄λ‹Ή κ³„μΈµμ—μ„ 1) μ”μ—¬ κ°μ‹¤ ν™•μΈ 2) κ°μ‹¤ μμ•½ λ΅μ§ λ“±μ΄ μ΄λ£¨μ–΄μ§€λ„λ΅ μ²λ¦¬ν•  μ μλ‹¤
- **μμ•½ μ„λΉ„μ¤** : μ”μ—¬ κ°μ‹¤ κ΄€λ¦¬ API μ κ³µ
    1. μ§€μ •λ νΈν…”κ³Ό κ°μ‹¤ μ ν•, μ£Όμ–΄μ§„ λ‚ μ§ λ²”μ„μ— μ΄μ© κ°€λ¥ν• κ°μ‹¤ μ μ§μ
    2. κ°μ‹¤ μμ•½ λ° total_reserved += 1
    3. μμ•½ μ·¨μ† μ‹, μ”μ—¬ κ°μ‹¤ μ κ°±μ‹ 
- **μ”μ—¬ κ°μ‹¤ μΊμ‹** : λ¨λ“  μ”μ—¬ κ°μ‹¤ κ΄€λ¦¬μ— ν•„μ”ν• μ§μλ¥Ό Redisλ΅ κµ¬ν„λ μΊμ‹λ΅ μ΄λ™μ‹ν‚΄
    
    β†’ μ‚¬μ „μ— μ”μ—¬ κ°μ‹¤ μ •λ³΄λ¥Ό μΊμ‹μ— λ―Έλ¦¬ μ €μ¥ν•΄λ‘¬μ•Ό ν•¨
    
    ```sql
    key: hotelID_roomTypeID_{λ‚ μ§}
    value: μ£Όμ–΄μ§„ νΈν…” ID, κ°μ‹¤ μ ν• ID, λ‚ μ§μ— λ§λ” μ”μ—¬ κ°μ‹¤ μ
    ```
    
- **μ”μ—¬ κ°μ‹¤ λ°μ΄ν„°λ² μ΄μ¤** : μ”μ—¬ κ°μ‹¤ μμ— λ€ν• κ°€μ¥ λ―Ώμ„ λ§ν• μ •λ³΄ λ³΄κ΄€
    
    

<aside>
π€ μΊμ‹ λ„μ… μ΄ν›„μ κ³Όμ  : **DB-μΊμ‹ κ°„μ λ°μ΄ν„° μΌκ΄€μ„± μ μ§€**

μ£Όλ΅ DBκ°€ λ¨Όμ € κ°±μ‹ λλ©΄ κ·Έ λ‹¤μ μΊμ‹μ— λΉ„λ™κΈ°μ μΌλ΅ λ³€κ²½ λ‚΄μ—­μ΄ λ°μλλ‹¤. 

β†’ μ΄ κ°±μ‹  μ‘μ—…μ΄ μ΄λ£¨μ–΄μ§€λ” κ²½λ΅λ” 

1. μ• ν”λ¦¬μΌ€μ΄μ… μΈ΅μ—μ„ DBμ— λ°μ΄ν„°λ¥Ό μ €μ¥ν• λ‹¤μ μΊμ‹ λ°μ΄ν„°λ¥Ό μμ •ν•κΈ°
2. λ³€κ²½ λ°μ΄ν„° κ°μ§€(CDC) λ©”μ»¤λ‹μ¦ μ‚¬μ© (e.g. λ“λ² μ§€μ›€) β†’ DB source connectorκ°€ λ³€ν™”λ¥Ό κ°μ§€ν•μ—¬ μΊμ‹μ— λ°μν•λ„λ΅ ν•κΈ°

μ„μ™€ κ°™μ€ λ°©μ‹μΌλ΅ κ°€λ¥ν•λ‹¤. κ·Έ μ‚¬μ΄μ— μ§μλ¥Ό ν•κ² λλ©΄ μΊμ‹μ—λ” μµμ‹  λ°μ΄ν„°κ°€ μ—†μ„ κ°€λ¥μ„±μ΄ μκ³ , μµμΆ…μ μΌλ΅ DBμ—μ„ μ”μ—¬ κ°μ‹¤μ„ ν™•μΈν•λ„λ΅ ν•λ©΄ λ¬Έμ κ°€ ν•΄κ²°λλ‹¤. 

</aside>

π‘π»Β μ¥μ 

- μ½κΈ° μ§μλ¥Ό μΊμ‹κ°€ μ²λ¦¬ν•λ―€λ΅ λ°μ΄ν„°λ² μ΄μ¤μ λ¶€ν•κ°€ ν¬κ² μ¤„μ–΄λ“¦
- μ½κΈ° μ§μλ¥Ό λ©”λ¨λ¦¬μ—μ„ μ‹¤ν–‰ν•λ―€λ΅ λ†’μ€ μ„±λ¥ λ³΄μ¥

π‘π»Β λ‹¨μ 

- λ°μ΄ν„°λ² μ΄μ¤μ™€ μΊμ‹ μ‚¬μ΄μ λ°μ΄ν„° μΌκ΄€μ„±μ„ μ μ§€ν•μ§€ λ»ν•  λ•μ μ‚¬μ©μ κ²½ν—μ€ μΉλ…μ μΌ μ μμ

### μ„λΉ„μ¤ κ°„ λ°μ΄ν„° μΌκ΄€μ„±

![λ¨λ…Έλ¦¬μ¤ VS λ§μ΄ν¬λ΅μ„λΉ„μ¤](https://github.com/user-attachments/assets/15a1dd73-8cb7-4357-99cf-861b31f4b19e)

λ¨λ…Έλ¦¬μ¤ VS λ§μ΄ν¬λ΅μ„λΉ„μ¤

λ¨λ…Έλ¦¬μ¤ μ•„ν‚¤ν…μ²λ” μ—¬λ¬ μ—°μ‚°μ„ ν•λ‚μ νΈλμ­μ…μΌλ΅ λ¬¶μ–΄ ACID μ†μ„±μ΄ λ§μ΅±λλ„λ΅ λ³΄μ¥ν•  μ μλ‹¤. ν•μ§€λ§ λ§μ΄ν¬λ΅μ„λΉ„μ¤ μ•„ν‚¤ν…μ²λ” κ° μ„λΉ„μ¤μ—μ„ λ…μμ μΌλ΅ DBλ¥Ό κ°–λ” κµ¬μ΅°μ΄λ―€λ΅, ν•λ‚μ μ›μμ  μ—°μ‚°μ΄ μ—¬λ¬ DBμ— μν•΄ μ‹¤ν–‰λλ” μΌμ„ ν”Όν•  μ μ—†λ‹¤. (μ¦‰, μ—¬λ¬ κ°μ νΈλμ­μ…μΌλ΅ μΌκ΄€μ„±μ„ λ³΄μ¥ν•΄μ•Ό ν•λ” μƒν™©)

β†’ μ΄λ” λ°μ΄ν„° λ¶μΌμΉλ¥Ό μΌμΌν‚¬ μ μμ–΄ μ„ν—

**`λ¨λ…Έλ¦¬μ¤ μ•„ν‚¤ν…μ²`**

![Untitled](https://github.com/user-attachments/assets/933e366c-16c6-46b4-bc46-826a19341af1)

**`λ§μ΄ν¬λ΅μ„λΉ„μ¤ μ•„ν‚¤ν…μ²`**

![Untitled](https://github.com/user-attachments/assets/c13e8996-2b92-479b-8fa0-32f94eb3df74)

**[λ°μ΄ν„° μΌκ΄€μ„± λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν• λ°©μ•]**

- 2λ‹¨κ³„ μ»¤λ°‹(2-phase commit, 2PC) : μ—¬λ¬ λ…Έλ“μ— κ±ΈμΉ μ›μμ  νΈλμ­μ… μ‹¤ν–‰μ„ λ³΄μ¦ν•λ” λ°μ΄ν„°λ² μ΄μ¤ ν”„λ΅ν† μ½
    - λ¨λ“  λ…Έλ“κ°€ μ„±κ³µ λλ” μ‹¤ν¨ λ‘ μ¤‘ ν•λ‚λ΅ νΈλμ­μ…μ΄ λ§λ¬΄λ¦¬λλ„λ΅ λ³΄μ¦
    - blocking protocol - λΉ„μ¤‘λ‹¨ μ‹¤ν–‰μ΄ κ°€λ¥ν•μ§€ μ•μΌλ―€λ΅, ν• λ…Έλ“μ— μ¥μ• κ°€ λ°μƒν•λ©΄ λ³µκµ¬λ  λ•κΉμ§€ μ§„ν–‰ μ¦λ‹¨ (μ„±λ¥μ€ κ·Έλ¦¬ λ›°μ–΄λ‚μ§€ X)
- μ‚¬κ°€(Saga) : κ° λ…Έλ“μ— κµ­μ§€μ μΌλ΅ λ°μƒν•λ” νΈλμ­μ…μ„ ν•λ‚λ΅ μ—®μ€ κ²ƒ
    - κ°κ°μ νΈλμ­μ…μ΄ μ™„λ£λλ©΄ λ‹¤μ νΈλμ­μ…μ„ μ‹μ‘μΌλ΅ ν•λ” νΈλ¦¬κ±°λ΅ μ“°μΌ λ©”μ‹μ§€λ¥Ό λ§λ“¤μ–΄ λ³΄λ‚Έλ‹¤
    - κ° λ‹¨κ³„κ°€ ν•λ‚μ νΈλμ­μ…μ΄λ―€λ΅, **κ²°κ³Όμ  μΌκ΄€μ„±**μ— μμ΅΄ν•λ” λ°©μ‹
        - μ–΄λ ν•λ‚λΌλ„ μ‹¤ν¨ν•λ©΄ κ·Έ μ΄μ „ νΈλμ­μ… κ²°κ³ΌκΉμ§€ μ „λ¶€ μμ°¨μ μΌλ΅ λλλ¦Ό
        

## 4λ‹¨κ³„ λ§λ¬΄λ¦¬

### μ”μ•½

![Untitled](https://github.com/user-attachments/assets/9b5d0f38-8be8-45bd-9018-cc77e5f98d87)
