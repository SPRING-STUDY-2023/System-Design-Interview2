# 6장 광고 클릭 이벤트 집계

<img alt="image" width="700" src="https://github.com/user-attachments/assets/f3a38371-73ef-4551-adf4-2d2c2e187437"/>

🔼 RTB 동작 절차

<br/>

## 1️⃣ 문제 이해 및 설계 범위 확정

### 기능 요구사항
- 지난 M분 동안의 ad_id 클릭 수 집계
- 매분 가장 많이 클릭된 상위 100개 광고 아이디를 반환
- 다양한 속성에 따른 집계 필터링을 지원
- 데이터의 양은 페이스북이나 구글 규모

<br/>

### 비기능 요구사항
- 집계 결과 정확성은 데이터가 RTB 및 광고 과금에 사용되므로 중요
- 지연되거나 중복된 이벤트를 적절히 처리할 수 있어야 함
- 견고성: 부분적인 장애는 감내할 수 있어야 함
- 지연 시간 요구사항: 전체 처리 시간은 최대 수 분을 넘지 않아야 함

<br/>

### 개략적 추정
- DAU 10억명
- 하루에 10억 건의 광고 클릭 이벤트가 발생
- 광고 클릭 QPS = 10,000 (10^9 / 10^5)
- 최대 광고 클릭 QPS는 평균 QPS의 5배로 가정
- 월간 저장 용량 요구량은 대략 3TB

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기

### 질의 API 설계

#### 지난 M분간 각 ad_id에 발생한 클릭 수 집계

```
GET /v1/ads/{:ad_id}/aggregated_count
```
- 주어진 ad_id에 발생한 이벤트 수를 집계하여 반환

<br/>

> **Request**

|인자명|뜻|자료형|
|--|--|--|
|from|집계 시작 시간|long|
|to|집계 종료 시간|long|
|filter|필터링 전략 식별자|long|

<br/>

> **Response**

|필드명|뜻|자료형|
|--|--|--|
|ad_id|광고(ad) 식별자|string|
|count|집계된 클릭 횟수|long|

<br/>

#### 지난 M분간 가장 많은 클릭이 발생한 상위 N개 ad_id 목록

```
GET /v1/ads/popular_ads
```
- 지난 M분간 가장 많은 클릭이 발생한 상위 N개 광고 목록 반환

<br/>

> **Request**

|인자명|뜻|자료형|
|--|--|--|
|count|상위 몇 개의 광고를 반환할 것인가|integer|
|window|분 단위로 표현된 집계 윈도 크기|integer|
|filter|필터링 전략 식별자|long|

<br/>

> **Response**

|필드명|뜻|자료형|
|--|--|--|
|ad_ids|광고 식별자 목록|array|

<br/>

### 데이터 모델

#### 집계 결과 데이터

|ad_id|click_minute|filter_id|count|
|--|--|--|--|
|...|...|...|...|

🔼 필터를 사용해 집계한 데이터

<br/>

#### 비교

| |원시 데이터만 보관하는 방안|집계 결과 데이터만 보관하는 방안|
|--|--|--|
|장점|- 원본 데이터를 손실 없이 보관 <br/> - 데이터 필터링 및 재계산 지원|- 데이터 용량 절감 <br/> - 빠른 질의 성능|
|단점|- 막대한 데이터 용량<br/> - 낮은 질의 성능|- 데이터 손실|

- 결론: 둘 다 저장하는 것이 좋다.
  - 문제가 발생하면 원시 데이터로 디버깅 가능하다.
  - 집계 결과 데이터로 빠르게 질의할 수 있다.

<br/>

### 올바른 데이터베이스의 선택
- (원시 데이터) 쓰기 및 시간 범위 질의에 최적화된 카산드라나 InfluxDB를 사용하는 것이 좀 더 바람직하다.
- (집계 데이터) 원시 데이터와 같은 유형의 데이터베이스를 활용하는 것이 가능하다.

<br/>

### 개략적 설계안

#### 비동기 처리
- 카프카 같은 메시지 큐를 도입하여 생산자와 소비자의 결합을 끊으면, 그 결과로 전체 프로세스는 비동기 방식으로 동작하게 되고, 생산자와 소비자의 규모를 독립적으로 확장해 나갈 수 있게 된다.

<br/>

<img alt="image" width="500" src="https://github.com/user-attachments/assets/479907ad-1654-43db-9fc7-b9e859d1e43d"/>

🔼 개략적 설계안

<br/>

<img alt="image" width="500" src="https://github.com/user-attachments/assets/171748bd-c5d9-410e-9790-153705a0585a"/>

🔼 정확하게 한 번 처리하기 위한 메커니즘

<br/>

### 집계 서비스
- 맵 노드: 데이터 출처에서 읽은 데이터를 필터링하고 변환하는 역할

<br/>

### 집계 노드
- 리듀스 노드: 모든 `집계` 노드가 산출한 결과를 최종 결과로 축약
- 주요 사용 사례
  - 클릭 이벤트 수 집계
  - 가장 많이 클릭된 상위 N개 광고 반환
  - 데이터 필터링
 
<br/>

## 3️⃣ 상세 설계
