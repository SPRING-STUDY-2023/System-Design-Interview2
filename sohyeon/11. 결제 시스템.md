# 11장 결제 시스템

## 1️⃣ 문제 이해 및 설계 범위 확정

### 기능 요구사항
- 대금 수신(pay-in) 흐름: 결제 시스템이 판매자를 대신하여 고객으로부터 대금을 수령한다.
- 대금 정산(pay-out) 흐름: 결제 시스템이 전 세계의 판매자에게 제품 판매 대금을 송금한다.

<br/>

### 비기능 요구사항
- 신뢰성 및 내결함성: 결제 실패는 신중하게 처리해야 한다.
- 내부 서비스와 외부 서비스 간의 조정 프로세스: 시스템 간의 결제 정보가 일치하는지 비동기적으로 확인한다.

<br/>

### 개략적인 규모 추정
- 하루 100만 건의 트랜잭션을 처리해야 한다. (초당 10건의 트랜잭션)

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기

### 대금 수신 흐름

<img alt="image" width="500" src="https://github.com/user-attachments/assets/55ddd43b-1fed-4eb5-ae3b-99f1f808bebb"/>

#### 결제 서비스
- 결제 서비스는 사용자로부터 결제 이벤트를 수락하고 결제 프로세스를 조율한다.
- 위험 확인을 통과한 결제만 처리한다.
- 위험 확인 서비스는 매우 복잡하고 고도로 전문화되어 있으므로 제 3자 제공업체를 이용한다.

<br/>

#### 결제 실행자
- 결제 실행자는 PSP를 통해 결제 주문 하나를 실행한다.
- 하나의 결제 이벤트에는 여러 결제 주문이 포함될 수 있다.

<br/>

#### 결제 서비스 공급자
- PSP는 A계정에서 B계정으로 돈을 옮기는 역할을 담당한다.

<br/>

#### 카드 유형
- 카드사는 신용 카드 업무를 처리하는 조직이다.
- ex. 비자, 마스터카드, 디스커버리 등

<br/>

#### 원장
- 원장은 결제 트랜잭션에 대한 금융 기록이다.
- 원장 시스템은 전자상거래 웹사이트의 총 수익을 계산하거나 향후 수익을 예측하는 등, 결제 후 분석에서 매우 중요한 역할을 한다.

<br/>

#### 지갑
- 지갑에는 판매자의 계정 잔액을 기록한다.

<br/>

#### 결제 흐름
1. 사용자가 `주문하기` 버튼을 클릭하면 결제 이벤트가 생성되어 결제 서비스로 전송된다.
2. 결제 서비스는 결제 이벤트를 데이터베이스에 저장한다.
3. 때로는 단일 결제 이벤트에 여러 결제 주문이 포함될 수 있다.
4. 결제 실행자는 결제 주문을 데이터베이스에 저장한다.
5. 결제 실행자가 외부 PSP를 호출하여 신용카드 결제를 처리한다.
6. 결제 실행자가 결제를 성공적으로 처리하면, 결제 서비스는 지갑을 갱신하여 특정 판매자의 잔고를 기록한다.
7. 지갑 서버는 갱신된 잔고 정보를 데이터베이스에 저장한다.
8. 지갑 서비스가 판매자 잔고를 성공적으로 갱신하면 결제 서비스는 원장을 호출한다.
9. 원장 서비스는 새 원장 정보를 데이터베이스에 추가한다.

<br/>

### 결제 서비스 API
- POST /v1/payments (결제 이벤트 실행)
- GET /v1/payments/{:id} (단일 결제 주문의 실행 상태 반환)

<br/>

### 결제 서비스 데이터 모델
- 테이블: 결제 이벤트, 결제 주문
- 중요한 고려사항
  1. 안정성이 검증되었는가?
  2. 모니터링 및 데이터 탐사에 필요한 도구가 풍부하게 지원되는가?
  3. DBA 채용 시장이 성숙했는가?
 
<br/>

### 복식부기 원장 시스템
- 원장 시스템에는 복식부기라는 중요한 설계 원칙이 있다.
- 복식부기는 모든 결제 시스템에 필수 요소이며 정확한 기록을 남기는 데 핵심적 역할을 한다.
  - 모든 결제 거래를 2개의 별도 원장 계좌에 같은 금액으로 기록한다.
  - 한 계좌에서는 차감이 이루어지고 다른 계좌에는 입금이 이루어진다.
 
<br/>

### 외부 결제 페이지
- 신용 카드 정보를 취급하지 않기 위해 기업들은 PSP에서 제공하는 외부 신용 카드 페이지를 사용한다.

<br/>

### 대금 정산 흐름
- 타사 정산 서비스를 사용하여 전자상거래 웹사이트 은행 계좌에서 판매자 은행 계좌로 돈을 이체한다.
- 일반적으로 결제 시스템은 대금 정산을 위해 외상 매입금 지급 서비스 제공업체를 이용한다.

<br/>

## 3️⃣ 상세 설계

### PSP 연동
1. 회사가 민감한 결제 정보를 안전하게 저장할 수 있다면 API를 통해 PSP와 연동한다.
2. 민감한 결제 정보를 저장하지 않는다면, PSP는 카드 결제 세부 정보를 수집하여 PSP에 안전하게 저장할 수 있도록 외부 결제 페이지를 제공한다.

<br/>

<img alt="image" width="500" src="https://github.com/user-attachments/assets/4b0dd894-fb0d-4768-ab06-ab950b1277fe"/>

1. 사용자가 클라이언트 브라우저에서 `결제` 버튼을 클릭한다. (결제 서비스 호출)
2. 결제 주문 정보를 수신한 결제 서비스는 결제 등록 요청을 PSP로 전송한다.
3. PSP는 결제 서비스에 토큰을 반환한다.
4. 결제 서비스는 PSP가 제공하는 외부 결제 페이지를 호출하기 전에 토큰을 데이터베이스에 저장한다.
5. 토큰을 저장하고 나면 클라이언트에게 PSP가 제공하는 외부 결제 페이지를 표시한다.
6. 사용자는 결제 서부 정보를 PSP의 웹 페이지에 입력한 다음 결제 버튼을 클릭한다.
7. PSP가 결제 상태를 반환한다.
8. 사용자는 리다이렉션 URL이 가리키는 웹 페이지로 보내진다.
9. 비동기적으로 PSP는 웹훅을 통해 결제 상태와 함께 결제 서비스를 호출한다.

<br/>

### 조정
- 관련 서비스 간의 상태를 주기적으로 비교하여 일치하는지 확인한다.
- 조정 시스템은 정산 파일의 세부 정보를 읽어 원장 시스템과 비교한다.
- 결제 시스템의 내부 일관성을 확인할 수도 있다.
  1. 어떤 유형의 문제인지 알고 있으며 문제 해결 절차를 자동화할 수 있는 경우: 자동화 프로그램 작성
  2. 어떤 유형의 문제인지는 알지만 문제 해결 절차를 자동화할 수 없는 경우: 작업 대기열에 넣고 재무팀에서 수동으로 수정
  3. 분류할 수 없는 유형의 문제인 경우: 특별 작업 대기열에 넣고 재무팀에서 조사
 
<br/>

### 결제 지연 처리
- PSP는 결제가 대기 상태임을 알리는 상태 정보를 클라이언트에게 반환하고, 클라이언트는 이를 사용자에게 표시한다.
- PSP는 우리 회사를 대신하여 대기 중인 결제의 진행 상황을 추적하고, 상태가 바뀌면 PSP에 등록된 웹훅을 통해 결제 서비스에 알린다.

<br/>

### 내부 서비스 간 커뮤니케이션
- 동기식 통신
  - 성능 저하
  - 장애 격리 곤란
  - 높은 결합도
  - 낮은 확장성
 
- 비동기 통신
  - 단일 수신자: 각 요청은 하나의 수신자 또는 서비스가 처리한다. (공유 메시지 큐 활용)
  - 다중 수신자: 각 요청은 여러 수신자 또는 서버가 처리한다.
 
<br/>

### 결제 실패 처리
- 결제 상태 추적: 결제 상태는 데이터 추가만 가능한 데이터베이스 테이블에 보관한다.
- 재시도 큐 및 실패 메시지 큐
  - 재시도 큐: 일시적 오류 같은 재시도 가능 오류는 재시도 큐에 보낸다.
  - 실패 메시지 큐: 반복적으로 처리에 실패한 메시지는 실패 메시지 큐로 보낸다.
 
<br/>

### 정확히 한 번 전달
- 재시도
  - 어떤 결제가 최소 한 번은 실행되도록 보장 가능하다.
  - `즉시 재시도`: 즉시 요청을 다시 보냄
  - `고정 간격`: 재시도 전에 일정 시간 기다림
  - `증분 간격`: 재시도 전에 기다리는 시간을 특정한 양만큼 점진적으로 늘려감
  - `지수적 백오프`: 재시도 전에 기다리는 시간을 직전 재시도 대비 2배씩 늘려감
  - `취소`: 요청을 철회
 
- 멱등성
  - 최대 한 번 실행을 보장한다.
  - 결제 요청의 멱등성을 보장하기 위해서 HTTP 헤더에 `<멱등 키: 값>`의 형태로 멱등 키를 추가한다.
 
<br/>

### 일관성
- 내부 서비스와 외부 서비스 간의 데이터 일관성 유지를 위해서 일반적으로 멱등성과 조정 프로세스를 활용한다.
- 데이터 다중화 중 발생하는 데이터 불일치 문제에는 2가지 해결방법이 있다.
  1. 주 데이터베이스에서만 읽기/쓰기 연산을 처리한다.
  2. 모든 사본이 항상 동기화되도록 한다. (ex. 합의 알고리즘, 합의 기반 분산 데이터베이스 등 사용)
 
<br/>

### 결제 보안

|문제|해결책|
|---|---|
|요청/응답 도청|HTTPS 사용|
|데이터 변조|암호화 및 무결성 강화 모니터링|
|중간자 공격|인증서 고정과 함께 SSL 사용|
|데이터 손실|여러 지역에 걸쳐 데이터베이스 복제 및 스냅샷 생성|
|분산 서비스 거부 공격(DDoS)|처리율 제한 및 방화벽|
|카드 도난|토큰화|
|PCI 규정 준수|PCI DSS는 브랜드 신용 카드를 처리하는 조직을 위한 정보 보안 표준이다.|
|사기|주소 확인, 카드 확인번호(CVV), 사용자 행동분석 등|

<br/>

## 4️⃣ 마무리
- 대금 수신 흐름/정산 흐름
- 재시도, 멱등성, 일관성
- 결제 오류 처리, 보안
