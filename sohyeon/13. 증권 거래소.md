# 13장 증권 거래소

## 1️⃣ 문제 이해 및 설계 범위 확정

### 비기능 요구사항
- 가용성: 최소 99.99%
- 결함 내성: 프로덕션 장애의 파급을 줄이기 위해 결함 내성과 빠른 복구 매커니즘이 필요
- 지연 시간: 밀리초 수준
- 보안: 계정 관리 시스템 필요

<br/>

### 개략적 규모 추정
- 100가지 주식
- 하루 10억 건의 주문
- 뉴욕증권거래소: 월-금, 09:30-16:00 영업 (6.5시간)
- 최대 QPS: 215,000

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기
### 증권 거래 101
- 브로커: 브로커 시스템은 개인 사용자가 증권을 거래하고 시장 데이터를 확인할 수 있도록 편리한 사용자 인터페이스를 제공한다.
- 기관 고객: 전문 증권 거래 소프트웨어를 사용하여 대량으로 거래한다.
- 지정가 주문: 가격이 고정된 매수 또는 매도 주문이다.
- 시장가 주문: 가격을 지정하지 않는 주문으로, 시장가로 즉시 체결된다.

<br/>

### 시장 데이터 수준
- L1: 최고 매수 호가, 매도 호가 및 수량이 포함된다.
- L2: 체결을 기다리는 물량의 호가를 어디까지 보여주는지 나타내는 등 L1보다 더 많은 수준의 가격 정보가 제공된다.
- L3: L2에서 더 나아가, 각 주문 가격에 체결을 기다리는 물량 정보까지 보여준다.

<br/>

### 봉 차트
- 특정 기간 동안의 주가
- 1분, 5분, 1시간, 1일, 1주일, 1개월

<br/>

### FIX
- Financial Information Exchange Protocol (금융 정보 교환 프로토콜)
- 증권 거래 정보 교환을 위한 기업 중립적인 통신 프로토콜

<br/>

### 개략적 설계안

<img alt="image" width="500" src="https://github.com/user-attachments/assets/4302a503-e8f3-4cfc-879b-fffb05c14388"/>

- (1) 고객이 브로커의 웹/모바일 앱을 통해 주문한다.
- (2) 브로커가 주문을 거래소에 전송한다.
- (3) 주문이 클라이언트 게이트웨이를 통해 거래소로 들어간다.
- (4)~(5) 주문 관리자가 위험 관리자가 설정한 규칙에 따라 위험성 점검을 수행한다.
- (6) 위험성 점검 과정을 통과한 주문에 대해, 주문 관리자는 지갑에 주문 처리 자금이 충분한지 확인한다.
- (7)~(9) 주문이 체결 엔진으로 전송된다.
- (10)~(14) 주문 집행 사실을 클라이언트에 전송한다.

<br/>

- M1. 체결 엔진은 주문이 체결되면 집행 기록 스트림을 만든다.
- M2. 시장 데이터 게시 서비스는 집행 기록 및 주문 스트림에서 얻은 데이터를 시장 데이터로 사용하여 봉 차트와 호가 창을 구성한다.
- M3. 시장 데이터는 실시간 분석 전용 스토리지에 저장된다.

<br/>

- R1~R2. 보고 서비스는 주문 및 실행 기록에서 보고에 필요한 모든 필드의 값을 모은 다음 그 값을 종합해 만든 레코드를 데이터베이스에 기록한다.

<br/>

### 거래 흐름
- 체결엔진
  - 각 주식 심볼에 대한 주문서 내지 호가 창을 유지 관리한다.
  - 매수 주문과 매도 주문을 연결한다.
  - 집행 기록 스트림을 시장 데이터로 배포한다.
 
- 시퀀서
  - 체결 엔진을 결정론적으로 만드는 핵심 구성 요소
  - 입력 시퀀서와 출력 시퀀서 2가지가 있고, 각각 고유한 순서를 유지한다.
 
- 주문 관리자
  - 한쪽에서는 주문을 받고 다른 쪽에서는 집행 기록을 받는다.
  - 클라이언트 게이트웨이를 통해 주문을 수신하고 실행한다.
    - 종합적 위험 점검 담당 컴포넌트에 주문을 보내어 위험성 검토
    - 사용자의 지갑에 거래를 처리하기에 충분한 자금이 있는지 확인
    - 주문을 시퀀시에 전달
   
- 클라이언트 게이트웨이
  - 클라이언트로 주문을 받아 주문 관리자에게 보낸다.
  - 지연 시간에 민감하고, 가벼워야 한다.
 
- 시장 데이터 흐름
  - 시장 데이터 게시 서비스는 체결 엔진에서 집행 기록을 수신하고 집행 기록 스트림에서 호가 창과 봉 차트를 만들어낸다.
 
- 보고 흐름
  - 거래 이력, 세금 보고, 규정 준수 여부 보고, 결산 등의 기능을 제공한다.
  - 정확성과 규정 준수가 핵심이다.
 
<br/>

### API 설계
- 주문
  - POST /v1/order
  - 주문 처리, 인증 필요
 
- 집행
  - GET /v1/execution?symbol={:symbol}&orderId={:orderId}&startTime={:startTime}&endTime={:endTime}
  - 집행 정보 질의
 
- 호가 창/주문서
  - GET /v1/marketdata/orderBook/L2?symbol={:symbol}&depth={:depth}
  - 주어진 주식 심볼, 주어진 깊이 값에 대한 L2 호가 창 질의 결과 반환
 
- 가격 변동 이력(봉 차트)
  - GET /v1/marketdata/candles?symbol={:symbol}&resolution={:resolution}&startTime={:startTime}&endTime={:endTime}
  - 주어진 시간 범위, 해상도, 심볼에 대한 봉 차트 데이터 질의 결과 반환
 
<br/>

### 데이터 모델
- 상품, 주문, 집행
  - 상품은 거래 대상 주식이 가진 속성으로 정의된다.
  - 주문은 매수/매도를 실행하라는 명령이다.
  - 집행 기록은 체결이 이루어진 결과다.
 
<br/>

### 호가 창
- 일정한 조회 시간
- 빠른 추가/취소/실행 속도
- 빠른 업데이트
- 최고 매수 호가/최저 매도 호가 질의
- 가격 수준 순회

<br/>

### 봉 차트
- 시장 데이터 프로세서가 시장 데이터를 만들 때 호가 창과 더불어 사용하는 핵심 자료 구조
- 메모리 최적화
  - 미리 메모리를 할당해 둔 링(ring) 버퍼에 봉을 보관하면 새 객체 할당 횟수를 줄일 수 있다.
  - 메모리에 두는 봉의 개수를 제한하고 나머지는 디스크에 보관한다.
 
<br/>

## 3️⃣ 상세 설계
