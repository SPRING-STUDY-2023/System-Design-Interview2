# 13장 증권 거래소

## 1️⃣ 문제 이해 및 설계 범위 확정

### 비기능 요구사항
- 가용성: 최소 99.99%
- 결함 내성: 프로덕션 장애의 파급을 줄이기 위해 결함 내성과 빠른 복구 매커니즘이 필요
- 지연 시간: 밀리초 수준
- 보안: 계정 관리 시스템 필요

<br/>

### 개략적 규모 추정
- 100가지 주식
- 하루 10억 건의 주문
- 뉴욕증권거래소: 월-금, 09:30-16:00 영업 (6.5시간)
- 최대 QPS: 215,000

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기
### 증권 거래 101
- 브로커: 브로커 시스템은 개인 사용자가 증권을 거래하고 시장 데이터를 확인할 수 있도록 편리한 사용자 인터페이스를 제공한다.
- 기관 고객: 전문 증권 거래 소프트웨어를 사용하여 대량으로 거래한다.
- 지정가 주문: 가격이 고정된 매수 또는 매도 주문이다.
- 시장가 주문: 가격을 지정하지 않는 주문으로, 시장가로 즉시 체결된다.

<br/>

### 시장 데이터 수준
- L1: 최고 매수 호가, 매도 호가 및 수량이 포함된다.
- L2: 체결을 기다리는 물량의 호가를 어디까지 보여주는지 나타내는 등 L1보다 더 많은 수준의 가격 정보가 제공된다.
- L3: L2에서 더 나아가, 각 주문 가격에 체결을 기다리는 물량 정보까지 보여준다.

<br/>

### 봉 차트
- 특정 기간 동안의 주가
- 1분, 5분, 1시간, 1일, 1주일, 1개월

<br/>

### FIX
- Financial Information Exchange Protocol (금융 정보 교환 프로토콜)
- 증권 거래 정보 교환을 위한 기업 중립적인 통신 프로토콜

<br/>

### 개략적 설계안

<img alt="image" width="500" src="https://github.com/user-attachments/assets/4302a503-e8f3-4cfc-879b-fffb05c14388"/>

- (1) 고객이 브로커의 웹/모바일 앱을 통해 주문한다.
- (2) 브로커가 주문을 거래소에 전송한다.
- (3) 주문이 클라이언트 게이트웨이를 통해 거래소로 들어간다.
- (4)~(5) 주문 관리자가 위험 관리자가 설정한 규칙에 따라 위험성 점검을 수행한다.
- (6) 위험성 점검 과정을 통과한 주문에 대해, 주문 관리자는 지갑에 주문 처리 자금이 충분한지 확인한다.
- (7)~(9) 주문이 체결 엔진으로 전송된다.
- (10)~(14) 주문 집행 사실을 클라이언트에 전송한다.

<br/>

- M1. 체결 엔진은 주문이 체결되면 집행 기록 스트림을 만든다.
- M2. 시장 데이터 게시 서비스는 집행 기록 및 주문 스트림에서 얻은 데이터를 시장 데이터로 사용하여 봉 차트와 호가 창을 구성한다.
- M3. 시장 데이터는 실시간 분석 전용 스토리지에 저장된다.

<br/>

- R1~R2. 보고 서비스는 주문 및 실행 기록에서 보고에 필요한 모든 필드의 값을 모은 다음 그 값을 종합해 만든 레코드를 데이터베이스에 기록한다.

<br/>

### 거래 흐름
- 체결엔진
  - 각 주식 심볼에 대한 주문서 내지 호가 창을 유지 관리한다.
  - 매수 주문과 매도 주문을 연결한다.
  - 집행 기록 스트림을 시장 데이터로 배포한다.
 
- 시퀀서
  - 체결 엔진을 결정론적으로 만드는 핵심 구성 요소
  - 입력 시퀀서와 출력 시퀀서 2가지가 있고, 각각 고유한 순서를 유지한다.
 
- 주문 관리자
  - 한쪽에서는 주문을 받고 다른 쪽에서는 집행 기록을 받는다.
  - 클라이언트 게이트웨이를 통해 주문을 수신하고 실행한다.
    - 종합적 위험 점검 담당 컴포넌트에 주문을 보내어 위험성 검토
    - 사용자의 지갑에 거래를 처리하기에 충분한 자금이 있는지 확인
    - 주문을 시퀀시에 전달
   
- 클라이언트 게이트웨이
  - 클라이언트로 주문을 받아 주문 관리자에게 보낸다.
  - 지연 시간에 민감하고, 가벼워야 한다.
 
- 시장 데이터 흐름
  - 시장 데이터 게시 서비스는 체결 엔진에서 집행 기록을 수신하고 집행 기록 스트림에서 호가 창과 봉 차트를 만들어낸다.
 
- 보고 흐름
  - 거래 이력, 세금 보고, 규정 준수 여부 보고, 결산 등의 기능을 제공한다.
  - 정확성과 규정 준수가 핵심이다.
 
<br/>

### API 설계
- 주문
  - POST /v1/order
  - 주문 처리, 인증 필요
 
- 집행
  - GET /v1/execution?symbol={:symbol}&orderId={:orderId}&startTime={:startTime}&endTime={:endTime}
  - 집행 정보 질의
 
- 호가 창/주문서
  - GET /v1/marketdata/orderBook/L2?symbol={:symbol}&depth={:depth}
  - 주어진 주식 심볼, 주어진 깊이 값에 대한 L2 호가 창 질의 결과 반환
 
- 가격 변동 이력(봉 차트)
  - GET /v1/marketdata/candles?symbol={:symbol}&resolution={:resolution}&startTime={:startTime}&endTime={:endTime}
  - 주어진 시간 범위, 해상도, 심볼에 대한 봉 차트 데이터 질의 결과 반환
 
<br/>

### 데이터 모델
- 상품, 주문, 집행
  - 상품은 거래 대상 주식이 가진 속성으로 정의된다.
  - 주문은 매수/매도를 실행하라는 명령이다.
  - 집행 기록은 체결이 이루어진 결과다.
 
<br/>

### 호가 창
- 일정한 조회 시간
- 빠른 추가/취소/실행 속도
- 빠른 업데이트
- 최고 매수 호가/최저 매도 호가 질의
- 가격 수준 순회

<br/>

### 봉 차트
- 시장 데이터 프로세서가 시장 데이터를 만들 때 호가 창과 더불어 사용하는 핵심 자료 구조
- 메모리 최적화
  - 미리 메모리를 할당해 둔 링(ring) 버퍼에 봉을 보관하면 새 객체 할당 횟수를 줄일 수 있다.
  - 메모리에 두는 봉의 개수를 제한하고 나머지는 디스크에 보관한다.
 
<br/>

## 3️⃣ 상세 설계

### 성능
- 지연 시간을 줄이는 방법은 2가지 있다.
  - 중요 경로에서 실행할 작업 수를 줄인다.
  - 각 작업의 소요 시간을 줄인다.
 
<br/>

### 이벤트 소싱
- 현재 상태를 저장하는 대신 상태를 변경하는 모든 이벤트의 변경 불가능한 로그를 유지한다.
- 모든 이벤트를 순서대로 재생하면 주문 상태를 복구할 수 있다.

<br/>

### 고가용성
- 서비스가 다운되면 즉각 복구해야 한다.
- SPOF를 식별해야 한다. 주 인스턴스를 다중화해야 한다.
- 장애 감지 및 백업 인스턴스로서의 장애 조치 결정이 빨라야 한다.

<br/>

### 결함 내성
- 주 서버가 다운되면 언제, 어떻게 부 서버로 자동 전환하는 결정을 내리나?
- 부 서버 가운데 새로운 리더는 어떻게 선출하는가?
- 복구 시간 목표는 얼마인가?
- 어떤 기능을 복구해야 하는가? 시스템이 성능 저하 상태로도 동작할 수 있는가?

<br/>

### 체결 알고리즘
- FIFO 체결 알고리즘 사용
- 특정 가격 수준에서 먼저 들어온 주문이 먼저 체결되고, 마지막 주문이 가장 나중에 체결된다.
- ex. 다크 풀

<br/>

### 결정론
- 기능적 결정론
  - 시퀀서나 이벤트 소싱 아키텍처를 도입함으로써 이벤트를 동일한 순서로 재생하면 항상 같은 결과를 얻을 수 있도록 보장
  - 이벤트 순서가 중요
 
- 지연 시간 결정론
  - 각 거래의 처리 시간이 거의 같다.
  - 지연 시간이 낮다는 것은 거래소가 거의 모든 거래에 안정적인 성능을 제공한다는 것이다.
 
<br/>

### 시장 데이터 게시 서비스 최적화
- 시장 데이터 게시 서비스는 체결 엔진의 체결 결과를 받아 이를 기반으로 호가 창과 봉 차트를 재구축한 다음 구독자에게 데이터를 게시한다.

<br/>

### 시장 데이터의 공정한 배포
- 모든 수신자가 동시에 시장 데이터를 받을 수 있도록 보장하는 것이 중요하다.
- 안정적 UDP를 사용하는 멀티캐스트는 한 번에 많은 참가자에게 업데이트를 브로드캐스트하기 좋다.

<br/>

### 멀티캐스트
- 유니캐스트: 하나의 출처에서 하나의 목적지로만 보내는 전송 프로토콜
- 브로드캐스트: 하나의 출처에서 전체 하위 네트워크로 보내는 방식
- 멀티캐스트: 하나의 출처에서 다양한 하위 네트워크상의 호스트들로 보내는 방식

<br/>

### 코로케이션
- 헤지 펀드 또는 브로커의 서버를 거래소와 같은 데이터 센터에 둘 수 있도록 한다.

<br/>

### 네트워크 보안
- 공개 서비스와 데이터를 비공개 서비스에서 분리하여 DDoS 공격이 가장 중요한 클라이언트에게 영향을 미치지 않도록 한다.
- 자주 업데이트되지 않는 데이터는 캐싱한다.
- 디도스 공격에 대비해 URL을 강화한다.
- 효과적인 허용/차단 리스트 매커니즘을 사용한다.
- 처리율 제한 기능을 활용한다.

<br/>

## 4️⃣ 마무리
- 대형 거래소를 위한 이상적인 배포 모델은 모든 것을 하나의 거대한 서버 또는 단일 프로세스에 배치하는 것이라는 결론에 도달한다.
- 최근 암호화폐 산업이 발전함에 따라 많은 암호화폐 거래소가 클라우드 인프라를 사용하여 서비스를 배포한다.
- 일부 탈중앙화 금융 프로젝트는 AMM 개념을 기반으로 하며, 심지어 호가 창도 없다.
