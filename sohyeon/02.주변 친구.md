# 2장 주변 친구
앱 사용자 가운데 본인 위치 정보 접근 권한을 허락한 사용자에 한해 인근의 친구 목록을 보여주는 시스템이다.<br/>
근접성 서비스의 경우 사업장 주소는 정적이지만, 주변 친구 위치는 자주 바뀔 수 있다.

<br/>

## 1️⃣ 문제 이해 및 설계 범위 확정
### 기능 요구사항
- 사용자는 모바일 앱에서 주변 친구를 확인할 수 있어야 한다.
- 친구 목록은 몇 초마다 한 번씩 갱신되어야 한다.

<br/>

### 비기능 요구사항
- 낮은 지연 시간: 주변 친구의 위치 변화가 반영되는 데 너무 오랜 시간이 걸리지 않아야 한다.
- 안정성: 시스템은 전반적으로 안정적이어야 하지만, 때로 몇 개 데이터가 유실되는 것 정도는 용인할 수 있다.
- 결과적 일관성: 위치 데이터를 저장하기 위해 강한 일관성을 지원하는 데이터 저장소를 사용할 필요는 없다. 복제본의 데이터가 원본과 동일하게 변경되기까지 몇 초 정도 걸리는 것은 용인할 수 있다.

<br/>

### 개략적 규모 추정
- 주변 친구는 5마일(8km) 반경 이내 친구로 정의한다.
- 친구 위치 정보는 30초 주기로 갱신한다.
- 평균적으로 매일 주변 친구 검색 기능을 활용하는 사용자는 1억명으로 가정한다.
- 동시 접속 사용자의 수는 DAU 수의 10%로 가정한다.
- 평균적으로 한 사용자는 400명의 친구를 갖는다고 가정한다.
- 앱은 페이지당 20명의 주변 친구를 표시하고, 사용자의 요청이 있으면 더 많은 주변 친구를 보여 준다.

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기
### 개략적 설계안

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/1c7c3e23-2e16-4151-a6a0-60f291ea97ea"/>

🔼 P2P 통신
- 이론적으로 순수한 P2P 방식으로 해결 가능하다.
- 활성 상태인 근방 모든 친구와 항구적 통신 상태를 유지하면 된다.
- 👎 통신 연결 상태가 좋지 않은 경우도 있고 사용할 수 있는 전력도 충분하지 않아서 실용적이지 않다.

<br/>

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/79b56830-4576-4846-8361-c60fb15db1fb"/>

🔼 공용 백엔드
- 좀 더 실용적인 설계안이다.
- 백엔드는 다음과 같은 역할을 수행한다.
  - 모든 활성 상태 사용자의 위치 변화 내역을 수신한다.
  - 사용자 위치 변경 내역을 수신할 때마다 해당 사용자의 모든 활성 상태 친구를 찾아서 그 친구들의 단말로 변경 내역을 전달한다.
  - 두 사용자의 사이의 거리가 특정 임계치보다 먼 경우에는 변경 내역을 전송하지 않는다.
 
- 👎 큰 규모에 적용하기 쉽지 않다.
  - 요구사항에 따르면 초당 334,000번의 위치 정보 갱신을 처리해야 한다.
  - 친구를 포함하면 초당 334,000 * 400 * 10% = 1400만 건의 위치 정보 갱신 요청을 처리해야 한다.
  - 결과적으로 엄청난 양의 갱신 내역을 사용자 단말로 보내야 한다.
 
<br/>

### 설계안

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/b9760268-9e3f-4ff7-8c8c-a90582591b3d"/>

🔼 개략적 설계안

> **로드밸런서**

- RESTful API 서버 및 양방향 유상태 웹소켓 서버 앞단에 위치한다.
- 부하를 고르게 분산하기 위해 트래픽을 서버들에 배분한다.

<br/>

> **RESTful API 서버**

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/1cd03a03-e199-464c-ba89-c444ca1f84ff"/>

🔼 RESTful API 요청 처리 흐름
- 무상태 API 서버의 클러스터로서, 통상적인 요청/응답 트래픽을 처리한다.
- 해당 API 계층은 친구를 추가/삭제하거나 사용자 정보를 갱신하는 등의 부가적인 작업을 처리한다.

<br/>

> **웹소켓 서버**

- 친구 위치 정보 변경을 거의 실시간에 가깝게 처리하는 유상태 서버 클러스터이다.
- 각 클라이언트는 그 가운데 한 대와 웹소켓 연결을 지속적으로 유지한다.
  - 검색 반경 내 친구 위치가 변경되면 해당 내역은 이 연결을 통해 클라이언트로 전송된다.
  - 모바일 클라이언트가 시작되면, 온라인 상태인 모든 주변 친구 위치를 해당 클라이언트로 전송한다.
 
<br/>

> **레디스 위치 정보 캐시**

- 레디스는 활성 상태 사용자의 가장 최근 위치 정보를 캐시하는 데 사용한다.
- TTL 기간이 지나면 해당 사용자는 비활성 상태로 바뀌고 그 위치 정보는 캐시에서 삭제된다.
- 캐시에 보관된 정보를 갱신할 때는 TTL도 갱신한다.

<br/>

> **사용자 데이터베이스**

- 사용자 데이터 및 사용자의 친구 관계 정보를 저장한다.
- 관계형 데이터베이스 또는 NoSQL 어느 쪽이든 사용 가능하다.

<br/>

> **위치 이동 이력 데이터베이스**

- 사용자의 위치 변동 이력을 보관한다.
- 주변 친구 표시와 직접 관계된 기능은 아니다.

<br/>

> **레디스 펍/섭 서버**

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/2506799d-fb73-455f-931f-34c637e5c3b3"/>

🔼 레디스 펍/섭
- 레디스 펍/섭은 초경량 메시지 버스로, 새로운 채널을 생성하는 것은 아주 값싼 연산이다.
- 웹소켓 서버를 통해 수신한 특정 사용자의 위치 정보 변경 이벤트는 해당 사용자에게 배정된 펍/섭 채널에 발행한다.
- 특정 사용자의 위치가 바뀌면 해당 사용자의 모든 친구의 웹소켓 연결 핸들러가 호출된다.
- 각 핸들러는 위치 변경 이벤트를 수신할 친구가 활성 상태면 거리를 계산하고, 새로 계산한 거리가 검색 반경 이내면 갱신된 위치와 시각을 웹소켓 연결을 통해 해당 친구의 클라이언트 앱으로 보낸다.

<br/>

> **주기적 위치 갱신**

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/54d32659-64f9-41ea-b6ba-15212e9ee863"/>

🔼 주기적 위치 갱신
1. 모바일 클라이언트가 위치가 변경된 사실을 로드밸런서에게 전송한다.
2. 로드밸런서는 그 위치 변경 내역을 해당 클라이언트와 웹소켓 서버 사이에 설정된 연결을 통해 웹소켓 서버로 보낸다.
3. 웹소켓 서버는 해당 이벤트를 위치 이동 이력 데이터베이스에 저장한다.
4. 웹소켓 서버는 새 위치를 위치 정보 캐시에 저장한다.
5. 웹소켓 서버는 레디스 펍/섭 서버의 해당 사용자 채널에 새 위치를 발행한다.
6. 레디스 펍/섭 채널에 발생된 새로운 위치 반경 이벤트는 모든 구독자에게 브로드캐스트된다.
7. 메시지를 받은 웹소켓 서버는 새 위치를 보낸 사용자와 메시지를 받은 사용자 사이의 거리를 새로 계산한다.
8. (도식화X) 계산 거리가 검색 반경을 넘지 않는다면, 새 위치 및 해당 위치로의 이동이 발생한 시각을 나타내는 타임스탬프를 해당 구독자의 클라이언트 앱으로 전송하고, 반경 거리를 넘지 않으면 보내지 않는다.

<br/>

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/0623b224-77bb-49b9-a7a5-bb3cdb91952c"/>

🔼 친구에게 위치 변경 내역 전송 (사용자1의 친구: 사용자 2,3,4 / 사용자 5의 친구: 사용자 4,6)
1. 사용자 1의 위치가 변경되면 그 변경 내역은 사용자1과의 연결을 유지하고 있는 웹소켓 서버에 전송된다.
2. 해당 변경 내역은 레디스 펍/섭 서버 내의 사용자1 전용 채널로 발행된다.
3. 레디스 펍/섭 서버는 해당 변경 내역을 모든 구독자에게 브로드캐스트한다.
4. 위치 변경 내역을 보낸 사용자와 구독자 사이의 거리(사용자1과 2의 거리)가 검색 반경을 넘지 않을 경우 새로운 위치는 사용자2의 클라이언트로 전송된다.

<br/>

### API 설계
