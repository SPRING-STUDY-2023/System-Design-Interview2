# 5장 지표 모니터링 및 경보 시스템

## 1️⃣ 문제 이해 및 설계 범위 확정

### 개략적 요구사항 및 가정
- 대규모 인프라를 모니터링 해야 함
  - 일간 능동 사용자 수 1억 명
  - 서버 풀 1,000개, 풀당 서버 수 100개. 서버당 100개의 운영 지표를 수집한다고 치면 모니터링해야 하는 지표의 수는 천만 개 수준
  - 데이터 보관 기간은 1년
  - 수집한 그대로 데이터를 보관하는 기간은 일주일. 그 뒤에는 1분 단위 데이터로 변환한 후에 30일간 보관. 그 뒤에는 1시간 단위 데이터로 변환한 뒤에 1년간 보관.
 
- 모니터링할 지표는 다양한데, 예를 들면 다음과 같은 것이 있음
  - CPU 사용률
  - 요청 수
  - 메모리 사용량
  - 메시지 큐 내의 메시지 수
 
<br/>

### 비기능 요구사항
- 규모 확장성: 시스템은 늘어나는 지표 수와 경보의 양에 맞게 확장될 수 있어야 한다.
- 낮은 응답 지연: 대시보드와 경보를 신속하게 처리할 수 있도록, 질의에 대한 낮은 응답 지연을 보장해야 한다.
- 안정성: 높은 안전성을 제공하여 중요 경보를 놓치지 않도록 해야 한다.
- 유연성: 기술은 계속 변화하므로, 미래의 신기술을 쉽게 통합할 수 있도록 유연하게 변경 가능한 파이프라인을 이용해 구축한 시스템이어야 한다.

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기

### 기본적 사항
- 데이터 수집: 여러 출처로부터 지표 데이터를 수집한다.
- 데이터 전송: 지표 데이터를 지표 모니터링 시스템으로 전송한다.
- 데이터 저장소: 전송되어 오는 데이터를 정리하고 저장한다.
- 경보: 밀려오는 데이터를 분석하고, 이상 징후를 감지하고, 경보를 발생시킨다.
- 시각화: 데이터를 차트나 그래프 등으로 제공한다.

<br/>

### 데이터 모델
- 지표 데이터는 통상 시계열 데이터 형태로 기록한다. (타임스탬프)
- 시계열 각각에는 고유한 이름이 붙고, 선택적으로 레이블(label)을 붙이기도 한다.

<br/>

> **사례1**

- production에서 사용 중인 서버 인스턴스의 특정 시간대의 CPU 부하를 알고 싶다고 가정한다.
- 시계열 데이터로 지표 이름(metric name), 레이블(host:i631,env:prod), 그리고 특정한 시각에 측정된 지표 데이터로 구성할 수 있다.

<br/>

> **사례2**

- 지난 10분간 특정 지역(us-west)에 위치한 모든 웹 서버의 CPU 부하 평균값을 알고 싶다고 가정한다.
- 개념적으로 지표 이름이 CPU.load이고 레이블에 포함된 지역 이름이 us-west인 데이터를 저장소에서 가져와 평균값을 구하면 된다.

<br/>

> **데이터 접근 패턴**

- 예제 시스템은 쓰기 부하는 막대하고, 읽기 부하는 spiky(일시적으로 치솟았다 사라짐)한 편이다.

<br/>

### 데이터 저장소 시스템
- 시장에서 가장 인기 있는 시계열 데이터베이스 2가지는 다음과 같다. (from DB-engines)
  - InfluxDB
  - 프로메테우스(Prometheus)
 
- 다량의 시계열 데이터를 저장하고 빠른 실시간 분석을 지원한다.
- 메모리 캐시와 디스크 저장소를 함께 사용한다.

<br/>

### 개략적 설계안

<img alt="image" width="500" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview2/assets/55437339/6c4b05e0-6a27-4ab8-ac93-15d4e6c6af63"/>

🔼 개략적 설계안
- 지표 출처: 지표 데이터가 만들어지는 곳으로 애플리케이션 서버, SQL 데이터베이스, 메시지 큐 등 어떤 것이든 가능하다.
- 지표 수집기: 지표 데이터를 수집하고 시계열 데이터에 기록하는 역할을 한다.
- 시계열 데이터베이스: 지표 데이터를 시계열 데이터 형태로 보관하는 저장소다.
- 질의 서비스: 질의 서비스는 시계열 데이터베이스에 보관된 데이터를 질의하고 가져오는 과정을 돕는 서비스다.
- 경보 시스템: 경보를 받아야 하는 다양한 대상으로 경보 알림을 전송하는 역할을 하는 시스템이다.
- 시각화 시스템: 지표를 다양한 형태의 그래프/차트로 시각화 하는 기능을 제공하는 시스템이다.

<br/>

## 3️⃣ 상세 설계
